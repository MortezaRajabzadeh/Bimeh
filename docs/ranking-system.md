# سیستم رتبه‌بندی خانواده‌ها

## 📋 خلاصه

سیستم رتبه‌بندی خانواده‌ها برای تعیین اولویت بیمه خانواده‌ها بر اساس معیارهای مختلف طراحی شده است. این سیستم از `spatie/laravel-query-builder` برای پیاده‌سازی حرفه‌ای فیلترها و سورت‌ها استفاده می‌کند.

## 🎯 ویژگی‌ها

### 1. محاسبه امتیاز وزنی
- هر معیار دارای وزن مشخصی است (0-10)
- امتیاز نهایی از مجموع وزن‌های معیارهای موجود در خانواده محاسبه می‌شود
- مثال: زن سرپرست (وزن 10) + بیکاری (وزن 2) = امتیاز 12

### 2. فیلترهای پیشرفته
- فیلتر بر اساس معیارهای خاص
- فیلتر بر اساس طرح‌های رتبه‌بندی
- فیلتر بر اساس محدوده امتیاز
- فیلتر بر اساس امتیاز حداقل/حداکثر

### 3. سورت‌های هوشمند
- سورت بر اساس امتیاز وزنی
- سورت بر اساس تعداد معیارها
- سورت بر اساس امتیاز اولویت (شامل عوامل اضافی)

## 🏗️ معماری

### فایل‌های اصلی

#### 1. فیلترهای سفارشی
```php
app/QueryFilters/FamilyRankingFilter.php
```
- `ranking`: فیلتر بر اساس معیارهای انتخاب شده
- `ranking_scheme`: فیلتر بر اساس طرح رتبه‌بندی
- `ranking_score_min/max`: فیلتر بر اساس محدوده امتیاز
- `ranking_score_range`: فیلتر بر اساس محدوده

#### 2. سورت‌های سفارشی
```php
app/QuerySorts/FamilyRankingSort.php
```
- `weighted_rank`: سورت بر اساس امتیاز وزنی
- `criteria_count`: سورت بر اساس تعداد معیارها
- `priority_score`: سورت بر اساس امتیاز اولویت

#### 3. کامپوننت Livewire
```php
app/Livewire/Insurance/FamiliesApproval.php
```
- متد `applyRankingFilter()`: اعمال فیلتر رتبه‌بندی
- متد `calculateDisplayScore()`: محاسبه امتیاز نمایش
- متد `sortBy()`: سورت با پشتیبانی از فیلدهای رتبه‌بندی

## 📊 نحوه محاسبه امتیاز

### امتیاز وزنی ساده
```sql
SELECT SUM(rs.weight)
FROM rank_settings rs
WHERE JSON_CONTAINS(families.acceptance_criteria, CAST(rs.id AS JSON))
AND rs.is_active = 1
```

### امتیاز اولویت (پیشرفته)
```sql
(
    امتیاز وزنی × 10
) + (
    تعداد اعضا × 2
) + (
    امتیاز سرپرست زن (50)
) + (
    امتیاز تاریخ ثبت (10-20)
)
```

## 🎛️ استفاده در رابط کاربری

### 1. مودال تنظیمات رتبه
- انتخاب معیارهای فعال
- تنظیم وزن‌ها
- اعمال فیلتر یا رتبه‌بندی پیشرفته

### 2. جدول خانواده‌ها
- نمایش امتیاز رتبه‌بندی
- سورت بر اساس امتیاز
- رنگ‌بندی بر اساس سطح امتیاز

### 3. فیلترهای پیشرفته
- فیلتر بر اساس محدوده امتیاز
- فیلتر بر اساس معیارهای خاص

## 🔧 API Endpoints

### فیلترها
```
GET /families?filter[ranking]=1,2,3
GET /families?filter[ranking_scheme]=1
GET /families?filter[ranking_score_min]=10
GET /families?filter[ranking_score_max]=50
GET /families?filter[ranking_score_range]=10,50
```

### سورت‌ها
```
GET /families?sort=weighted_rank
GET /families?sort=-weighted_rank
GET /families?sort=criteria_count
GET /families?sort=priority_score
```

## 🧪 تست‌ها

### فایل تست
```php
tests/Feature/FamilyRankingTest.php
```

### تست‌های موجود
- محاسبه امتیاز رتبه‌بندی
- سورت خانواده‌ها بر اساس امتیاز
- فیلتر بر اساس طرح رتبه‌بندی
- محاسبه امتیاز اولویت
- مدیریت خطاها

## 📈 مثال‌های عملی

### مثال 1: خانواده با زن سرپرست
- معیار: زن سرپرست (وزن 10)
- امتیاز: 10
- اولویت: بالا

### مثال 2: خانواده با بیکاری
- معیار: بیکاری (وزن 2)
- امتیاز: 2
- اولویت: متوسط

### مثال 3: خانواده با چندین معیار
- معیارها: زن سرپرست (10) + بیکاری (2) + بیماری خاص (5)
- امتیاز: 17
- اولویت: خیلی بالا

## 🔄 به‌روزرسانی‌ها

### نسخه 1.0
- پیاده‌سازی اولیه سیستم رتبه‌بندی
- فیلترها و سورت‌های پایه
- رابط کاربری مودال

### نسخه 1.1 (آینده)
- الگوریتم‌های پیشرفته‌تر
- یادگیری ماشین
- پیش‌بینی اولویت

## 🚀 نصب و راه‌اندازی

### پیش‌نیازها
```bash
composer require spatie/laravel-query-builder
```

### تنظیمات
1. اطمینان از وجود جدول `rank_settings`
2. تنظیم معیارهای اولیه
3. فعال‌سازی کش برای عملکرد بهتر

### استفاده
```php
// در کامپوننت Livewire
$this->applyRankingFilter([1, 2, 3]); // معیارهای 1، 2، 3

// در API
$families = QueryBuilder::for(Family::class)
    ->allowedFilters(['ranking', 'ranking_scheme'])
    ->allowedSorts(['weighted_rank', 'priority_score'])
    ->get();
```

## 📞 پشتیبانی

برای سوالات و مشکلات:
- ایجاد Issue در GitHub
- تماس با تیم توسعه
- بررسی مستندات API 