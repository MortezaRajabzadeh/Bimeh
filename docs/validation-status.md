# مستندات سیستم اعتبارسنجی خانواده‌ها

## فهرست مطالب
- [معرفی](#معرفی)
- [وضعیت‌های اعتبارسنجی](#وضعیت-های-اعتبارسنجی)
- [رنگ‌بندی وضعیت‌ها](#رنگ-بندی-وضعیت-ها)
- [کامپوننت‌های رابط کاربری](#کامپوننت-های-رابط-کاربری)
- [مدل‌ها و متدهای مرتبط](#مدل-ها-و-متدهای-مرتبط)
- [بهینه‌سازی‌ها](#بهینه-سازی-ها)

## معرفی
سیستم اعتبارسنجی خانواده‌ها برای بررسی و اعتبارسنجی اطلاعات خانواده‌های تحت پوشش طراحی شده است. این سیستم وضعیت تکمیل اطلاعات، مدارک و سایر الزامات را بررسی و گزارش می‌دهد.

## وضعیت‌های اعتبارسنجی

### ۱. وضعیت هویتی
- **توضیحات**: بررسی کامل بودن اطلاعات هویتی اعضای خانواده
- **محاسبه درصد**: میانگین درصد تکمیل اطلاعات هویتی همه اعضا
- **وضعیت‌های ممکن**:
  - `complete` (کامل): اطلاعات هویتی همه اعضا کامل است
  - `partial` (ناقص): اطلاعات هویتی برخی اعضا کامل است
  - `none` (ندارد): هیچ اطلاعات هویتی ثبت نشده است

### ۲. وضعیت موقعیت جغرافیایی
- **توضیحات**: بررسی محرومیت منطقه‌ای خانواده
- **وضعیت‌های ممکن**:
  - `complete` (غیرمحروم): منطقه غیرمحروم است
  - `none` (محروم): منطقه محروم است

### ۳. مدارک
- **توضیحات**: بررسی مدارک مورد نیاز اعضا (معلولیت، بیماری خاص، بیماری مزمن)
- **محاسبه درصد**: نسبت اعضای دارای مدارک کامل به کل اعضای نیازمند مدرک
- **وضعیت‌های ممکن**:
  - `complete` (کامل): همه مدارک مورد نیاز آپلود شده‌اند
  - `partial` (ناقص): برخی مدارک آپلود شده‌اند
  - `none` (ندارد): هیچ مدرکی آپلود نشده است

### ۴. اطلاعات ناقص اعضا
- **توضیحات**: بررسی اطلاعات ناقص اعضای خانواده
- **وضعیت‌های ممکن**:
  - `complete` (کامل): هیچ اطلاعات ناقصی وجود ندارد
  - `warning` (هشدار): برخی اطلاعات ناقص است

## رنگ‌بندی وضعیت‌ها

رنگ‌بندی وضعیت‌ها در فایل پیکربندی `config/ui.php` تعریف شده است:

```php
'status_colors' => [
    'complete' => [
        'bg_class' => 'bg-green-100',
        'border_class' => 'border-green-300',
        'icon_class' => 'text-green-600',
        'text_class' => 'text-green-800'
    ],
    'partial' => [
        'bg_class' => 'bg-yellow-100',
        'border_class' => 'border-yellow-300',
        'icon_class' => 'text-yellow-600',
        'text_class' => 'text-yellow-800'
    ],
    'none' => [
        'bg_class' => 'bg-red-100',
        'border_class' => 'border-red-300',
        'icon_class' => 'text-red-600',
        'text_class' => 'text-red-800'
    ],
    'warning' => [
        'bg_class' => 'bg-orange-100',
        'border_class' => 'border-orange-300',
        'icon_class' => 'text-orange-600',
        'text_class' => 'text-orange-800'
    ]
]
```

## کامپوننت‌های رابط کاربری

### ۱. کامپوننت FamilyValidationIcons
نمایش آیکون‌های وضعیت اعتبارسنجی خانواده به صورت عمودی

#### ویژگی‌ها (Props)
- `family`: مدل خانواده
- `showTooltips`: نمایش tooltip اطلاعات (پیش‌فرض: true)
- `size`: اندازه آیکون‌ها (مقادیر مجاز: sm, md, lg - پیش‌فرض: md)

#### استایل‌دهی
- اندازه‌های مختلف آیکون‌ها:
  - sm: 20x20 پیکسل
  - md: 24x24 پیکسل (پیش‌فرض)
  - lg: 32x32 پیکسل

### ۲. کامپوننت FamilyValidationDetail
نمایش جزئیات وضعیت اعتبارسنجی خانواده

## مدل‌ها و متدهای مرتبط

### مدل Family

#### متدهای اصلی
1. **getAllValidationStatuses()**
   - **وظیفه**: دریافت تمام وضعیت‌های اعتبارسنجی خانواده
   - **خروجی**: آرایه‌ای شامل وضعیت‌های هویتی، موقعیت، مدارک و اطلاعات ناقص

2. **getIdentityValidationStatus()**
   - **وظیفه**: بررسی وضعیت اطلاعات هویتی اعضا
   - **خروجی**:
     ```php
     [
         'status' => 'complete'|'partial'|'none',
         'percentage' => 0-100,
         'message' => 'پیام وضعیت',
         'complete_members' => تعداد اعضای کامل,
         'total_members' => تعداد کل اعضا,
         'details' => [/* جزئیات هر عضو */]
     ]
     ```

3. **getLocationValidationStatus()**
   - **وظیفه**: بررسی وضعیت محرومیت منطقه‌ای
   - **خروجی**:
     ```php
     [
         'status' => 'complete'|'none',
         'percentage' => 0|100,
         'message' => 'پیام وضعیت',
         'province_name' => 'نام استان',
         'is_deprived' => true|false,
         'deprivation_rank' => 'رتبه محرومیت',
         'path' => 'مسیر استخراج موقعیت'
     ]
     ```

4. **getDocumentsValidationStatus()**
   - **وظیفه**: بررسی وضعیت مدارک اعضا
   - **خروجی**:
     ```php
     [
         'status' => 'complete'|'partial'|'none',
         'percentage' => 0-100,
         'message' => 'پیام وضعیت',
         'complete_members' => تعداد اعضای با مدارک کامل,
         'total_members_requiring_docs' => تعداد کل اعضای نیازمند مدرک,
         'details' => [/* جزئیات مدارک هر عضو */],
         'has_issue' => true|false,
         'last_updated' => 'تاریخ آخرین بروزرسانی'
     ]
     ```

## بهینه‌سازی‌ها

### ۱. کش‌گذاری (Caching)
- نتایج اعتبارسنجی به مدت 1 ساعت در حافظه کش ذخیره می‌شوند.
- از کلیدهای اختصاصی برای هر خانواده استفاده می‌شود.
- در صورت تغییر اطلاعات، کش به صورت خودکار باطل می‌شود.

### ۲. Eager Loading
- برای جلوگیری از مشکل N+1 از eager loading برای روابط استفاده شده است.

### ۳. مدیریت خطا
- تمامی متدها شامل مدیریت خطا برای مواردی که اطلاعات وجود ندارد هستند.
- مقادیر پیش‌فرض برای جلوگیری از خطاهای احتمالی تعیین شده‌اند.

## نکات فنی

### نحوه استفاده از کش
```php
// ذخیره در کش به مدت 1 ساعت
return Cache::remember('family_validation_' . $this->id, now()->addHours(1), function () {
    // محاسبات اعتبارسنجی
    return $result;
});

// باطل کردن کش در صورت تغییر اطلاعات
Cache::forget('family_validation_' . $family->id);
```

### افزودن وضعیت جدید
1. اضافه کردن وضعیت جدید به متد `getAllValidationStatuses()`
2. تعریف متد جدید برای محاسبه وضعیت
3. اضافه کردن کلاس‌های رنگی مورد نیاز در `config/ui.php`
4. به‌روزرسانی کامپوننت‌های نمایشی

## عیب‌یابی

### مشکل: درصد اعتبارسنجی به درستی نمایش داده نمی‌شود
- بررسی کنید که آیا کش به درستی به‌روز می‌شود یا خیر
- مطمئن شوید که همه متدهای اعتبارسنجی مقدار `percentage` را برمی‌گردانند
- لاگ‌های سرور را برای خطاهای احتمالی بررسی کنید

### مشکل: آیکون‌ها به درستی نمایش داده نمی‌شوند
- بررسی کنید که کلاس‌های Tailwind به درستی بارگذاری شده‌اند
- از وجود فونت آیکون‌ها مطمئن شوید
- console مرورگر را برای خطاهای جاوااسکریپت بررسی کنید
