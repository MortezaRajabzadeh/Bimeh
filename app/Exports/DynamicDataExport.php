<?php
namespace App\Exports;
use Illuminate\Support\Collection;
use Maatwebsite\Excel\Concerns\FromCollection;
use Maatwebsite\Excel\Concerns\WithHeadings;
use Maatwebsite\Excel\Concerns\WithMapping;
use Maatwebsite\Excel\Concerns\WithColumnFormatting;
use Maatwebsite\Excel\Concerns\WithColumnWidths;
use PhpOffice\PhpSpreadsheet\Style\NumberFormat;
/**
 * ???? Export ???????? ???? ????? ????
 * 
 * ??? ???? ?? ???? ???????? ??????? ?? ?? ???? ???? ????? ??????
 */
class DynamicDataExport implements FromCollection, WithHeadings, WithMapping, WithColumnFormatting, WithColumnWidths
{
    /**
     * ?????? ??????? ???? ?????
     *
     * @var Collection
     */
    protected $collection;
    /**
     * ?????? ???????? ????
     *
     * @var array
     */
    protected $headings;
    /**
     * ??????? ???? ???? ?????
     *
     * @var array
     */
    protected $dataKeys;
    /**
     * ?????? ????
     *
     * @param Collection $collection ?????? ???????
     * @param array $headings ?????? ???????
     * @param array $dataKeys ??????? ???? ???? ???????
     */
    public function __construct(Collection $collection, array $headings, array $dataKeys)
    {
        $this->collection = $collection;
        $this->headings = $headings;
        $this->dataKeys = $dataKeys;
    }
    /**
     * ?????????? ?????? ???????
     *
     * @return Collection
     */
    public function collection()
    {
        return $this->collection;
    }
    /**
     * ?????????? ?????? ???????
     *
     * @return array
     */
    public function headings(): array
    {
        return $this->headings;
    }
    /**
     * ????? ?? ???? ???? ?? ?????
     *
     * @param mixed $row
     * @return array
     */
    public function map($row): array
    {
        $mappedRow = [];
        foreach ($this->dataKeys as $key) {
            // ??????? ????? ?? ???????? ?? ??????? ?? ?? ?? (??? 'head.name')
            $value = data_get($row, $key, '---');
            // ?????? ???? ???: ????? ????? ???????
            if (str_contains($key, 'members_count') || str_contains($key, 'members.count')) {
                $value = isset($row->members) ? $row->members->count() : 0;
            }
            // ????? Enum ?? ?????
            if ($value instanceof \App\Enums\InsuranceWizardStep) {
                $value = $value->label();
            }
            $mappedRow[] = $value;
        }
        return $mappedRow;
    }
    /**
     * ????? ???? ???????? ????
     *
     * @return array
     */
    public function columnFormats(): array
    {
        $formats = [];
        // ???? ???? ???????? ?? ??? ? ????? ???? ???? ???? ?????
        foreach ($this->dataKeys as $index => $key) {
            if (str_contains($key, 'national_code')) {
                // ????? ????? ?? ??? ???? ???? (0 -> A, 1 -> B, ...)
                $columnLetter = \PhpOffice\PhpSpreadsheet\Cell\Coordinate::stringFromColumnIndex($index + 1);
                // ????? ???? ?? ??? ?? ???? ?? ??? ?? ?? ????? ??? ?????
                $formats[$columnLetter] = NumberFormat::FORMAT_TEXT;
            }
        }
        return $formats;
    }
    /**
     * ????? ??? ???????? ????
     *
     * @return array
     */
    public function columnWidths(): array
    {
        $widths = [];
        // ????? ??? ????? ???? ???? ???????
        foreach ($this->dataKeys as $index => $key) {
            $columnLetter = \PhpOffice\PhpSpreadsheet\Cell\Coordinate::stringFromColumnIndex($index + 1);
            // ??? ??????? 20 ???? (????? ?????? 150 ?????)
            // ??? ????? ?? ?????? ???? PhpSpreadsheet ???? ????
            $widths[$columnLetter] = 20;
        }
        return $widths;
    }
}